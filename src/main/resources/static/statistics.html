<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¬¸ í†µê³„ - NeoOrder</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/auth.js"></script>
</head>
<body>
    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="main-nav">
        <div class="logo" onclick="location.href='index.html'">ğŸ“¦ NeoOrder Lite</div>
        <ul class="menu">
            <li onclick="location.href='index.html'" data-i18n="nav.home">í™ˆ</li>
            <li onclick="location.href='orders.html'" data-i18n="nav.orders">ì£¼ë¬¸ ëª©ë¡</li>
            <li onclick="handleProtectedLink('new-order.html')" data-i18n="order.create.title">ìƒˆ ì£¼ë¬¸</li>
            <li class="active" data-i18n="nav.statistics">í†µê³„</li>
        </ul>
        <div style="display: flex; align-items: center; gap: 8px;">
            <nav id="auth-nav"></nav>
            <button class="lang-btn" onclick="i18n.changeLang('ko')">ğŸ‡°ğŸ‡·</button>
            <button class="lang-btn" onclick="i18n.changeLang('en')">ğŸ‡ºğŸ‡¸</button>
        </div>
    </nav>
    <div class="stats-container">
        <!-- ê²€ìƒ‰/ì¡°íšŒ ë°” -->
        <div class="search-bar">
            <div>
                <label for="startDate" data-i18n="stats.date.start">ì‹œì‘ì¼</label>
                <input type="date" id="startDate">
            </div>
            <div>
                <label for="endDate" data-i18n="stats.date.end">ì¢…ë£Œì¼</label>
                <input type="date" id="endDate">
            </div>
            <button class="button-main" id="searchButton" onclick="loadStatistics()">
                <span class="material-icons">search</span>
                <span data-i18n="stats.button.search">ì¡°íšŒ</span>
            </button>
            <button class="button-main" onclick="exportToCSV()">
                <span class="material-icons">file_download</span>
                <span data-i18n="stats.button.csv">CSV ë‹¤ìš´ë¡œë“œ</span>
            </button>
            <button class="button-main" onclick="exportCharts()">
                <span class="material-icons">image</span>
                <span data-i18n="stats.button.charts">ì°¨íŠ¸ ì €ì¥</span>
            </button>
        </div>
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-cards">
            <div class="stats-card">
                <div class="stats-card-title" data-i18n="stats.total.orders">ì´ ì£¼ë¬¸</div>
                <div class="stats-card-value" id="totalOrders">0</div>
                <div class="stats-card-unit" data-i18n="stats.unit.count">ê±´</div>
            </div>
            <div class="stats-card">
                <div class="stats-card-title" data-i18n="stats.completion.rate">ì™„ë£Œìœ¨</div>
                <div class="stats-card-value" id="completionRate">0%</div>
                <div class="stats-card-unit" data-i18n="stats.unit.percent">%</div>
            </div>
            <div class="stats-card">
                <div class="stats-card-title" data-i18n="stats.avg.time">í‰ê·  ì²˜ë¦¬ ì‹œê°„</div>
                <div class="stats-card-value" id="avgProcessingTime">0</div>
                <div class="stats-card-unit" data-i18n="stats.unit.minutes">ë¶„</div>
            </div>
        </div>
        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <div class="charts-row">
            <div class="chart-card">
                <div class="stats-card-title" data-i18n="stats.status.distribution">ì£¼ë¬¸ ìƒíƒœ ë¶„í¬</div>
                <canvas id="statusChart" height="300"></canvas>
            </div>
            <div class="chart-card">
                <div class="stats-card-title" data-i18n="stats.popular.items">ì¸ê¸° ìƒí’ˆ TOP 5</div>
                <canvas id="popularItemsChart" height="300"></canvas>
            </div>
        </div>
        <!-- ë°ì´í„° ì—†ìŒ ë©”ì‹œì§€ -->
        <div id="noData" data-i18n="stats.no.data">
            ì„ íƒí•œ ê¸°ê°„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
    </div>
    <!-- í‘¸í„° -->
    <footer class="footer">
        Â© 2025 YoungJee Park. All rights reserved.<br>
        Built with Java & JavaScript | Hosted on Render
    </footer>
    <script>
        let statusChart = null;
        let popularItemsChart = null;
        let dateChangeTimer = null;

        // ì°¨íŠ¸ ë ˆì´ë¸” ì—…ë°ì´íŠ¸
        function updateChartLabels() {
            if (statusChart && statusChart.data.labels) {
                // í˜„ì¬ ë°ì´í„°ì˜ ìƒíƒœê°’ë§Œ ì¶”ì¶œí•˜ì—¬ ë‹¤ì‹œ ë ˆì´ë¸” ìƒì„±
                const currentStatuses = Object.keys(statusChart.data.datasets[0].data).map((_, index) => {
                    const label = statusChart.data.labels[index];
                    // ìƒíƒœê°’ ì¶”ì¶œ (ì˜ˆ: "ì ‘ìˆ˜ë¨" -> "RECEIVED")
                    const status = Object.keys(translations.ko).find(key => 
                        translations.ko[key] === label || translations.en[key] === label
                    )?.replace('order.status.', '').toUpperCase() || label;
                    return status;
                });

                // ì¶”ì¶œëœ ìƒíƒœê°’ìœ¼ë¡œ ìƒˆ ë ˆì´ë¸” ìƒì„±
                const newLabels = currentStatuses.map(status => getStatusLabel(status));
                statusChart.data.labels = newLabels;
                statusChart.update('none'); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì—…ë°ì´íŠ¸
            }
        }

        // ìƒíƒœ ë ˆì´ë¸” ë³€í™˜ í•¨ìˆ˜
        function getStatusLabel(status) {
            // ìƒíƒœê°’ì„ ì •ê·œí™”
            const normalizedStatus = status.toLowerCase().replace(/^order\.status\./i, '');
            return i18n.getTranslation('order.status.' + normalizedStatus);
        }

        // ì–¸ì–´ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('languageChanged', () => {
            if (popularItemsChart) {
                popularItemsChart.data.datasets[0].label = i18n.getCurrentLang() === 'ko' ? 'ì£¼ë¬¸ ìˆ˜' : 'Orders';
                popularItemsChart.update();
            }
            updateChartLabels();
        });

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDefaultDateRange() {
            const now = new Date();
            const end = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), 1); // í˜„ì¬ ë‹¬ì˜ 1ì¼
            
            return {
                start: formatDate(start),
                end: formatDate(end)
            };
        }

        function initializeCharts() {
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const popularItemsCtx = document.getElementById('popularItemsChart').getContext('2d');

            statusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#4CAF50', // Received (green)
                            '#F44336', // Cancelled (red)
                            '#2196F3', // Completed (blue)
                            '#FFD600', // Shipping (yellow)
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });

            popularItemsChart = new Chart(popularItemsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: i18n.getCurrentLang() === 'ko' ? 'ì£¼ë¬¸ ìˆ˜' : 'Orders',
                        data: [],
                        backgroundColor: '#3f51b5'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: 0,
                            max: 1,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateCharts(data) {
            // ìƒíƒœ ë¶„í¬ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            const statusData = data.statusStats;
            const statusLabels = Object.keys(statusData).map(status => {
                // ìƒíƒœê°’ì—ì„œ 'order.status.' ì ‘ë‘ì‚¬ ì œê±°
                const cleanStatus = status.replace(/^order\.status\./i, '');
                return getStatusLabel(cleanStatus);
            });
            
            statusChart.data.labels = statusLabels;
            statusChart.data.datasets[0].data = Object.values(statusData);
            statusChart.update('active');

            // ì¸ê¸° ìƒí’ˆ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            const popularItems = data.popularItems;
            popularItemsChart.data.labels = popularItems.map(item => item.item);
            popularItemsChart.data.datasets[0].data = popularItems.map(item => item.count);
            popularItemsChart.data.datasets[0].label = i18n.getCurrentLang() === 'ko' ? 'ì£¼ë¬¸ ìˆ˜' : 'Orders';
            // yì¶• min/max ê°•ì œ ì¬ì„¤ì • (Chart.js ë‚´ë¶€ ì˜µì…˜ ìºì‹± ë¬¸ì œ ìš°íšŒ)
            const maxValue = Math.max(...popularItemsChart.data.datasets[0].data, 0);
            popularItemsChart.options.scales.y = {
                beginAtZero: true,
                min: 0,
                max: maxValue > 0 ? maxValue + 1 : 1,
                ticks: { stepSize: 1 }
            };
            popularItemsChart.update('active');
        }

        function updateStatistics(data) {
            // ìˆ«ì ì¦ê°€ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ í•¨ìˆ˜
            function animateValue(element, start, end, duration) {
                const range = end - start;
                const startTime = performance.now();
                
                function updateNumber(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    const value = Math.round(start + (range * progress));
                    element.textContent = element.id === 'completionRate' ? value + '%' : value;
                    
                    if (progress < 1) {
                        requestAnimationFrame(updateNumber);
                    }
                }
                
                requestAnimationFrame(updateNumber);
            }

            // ê° í†µê³„ ê°’ì— ì• ë‹ˆë©”ì´ì…˜ ì ìš©
            const totalOrdersElement = document.getElementById('totalOrders');
            animateValue(totalOrdersElement, parseInt(totalOrdersElement.textContent), data.totalOrders, 1000);
            
            const completionRateElement = document.getElementById('completionRate');
            const currentRate = parseInt(completionRateElement.textContent);
            const completedCount = data.statusStats['COMPLETED'] || 0;
            const newRate = data.totalOrders > 0 ? Math.round((completedCount / data.totalOrders) * 100) : 0;
            animateValue(completionRateElement, currentRate, newRate, 1000);
            
            const avgProcessingTimeElement = document.getElementById('avgProcessingTime');
            animateValue(avgProcessingTimeElement, parseInt(avgProcessingTimeElement.textContent), data.avgProcessingTime, 1000);
        }

        function handleDateChange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                if (new Date(startDate) > new Date(endDate)) {
                    alert(i18n.getTranslation('alert.date.invalid'));
                    document.getElementById('startDate').value = endDate;
                    return;
                }

                if (dateChangeTimer) {
                    clearTimeout(dateChangeTimer);
                }

                dateChangeTimer = setTimeout(() => {
                    loadStatistics();
                }, 500);
            }
        }

        async function loadStatistics() {
            const loadingElement = document.getElementById('loading');
            const contentElement = document.getElementById('statisticsContent');
            const noDataElement = document.getElementById('noData');
            const searchButton = document.getElementById('searchButton');

            try {
                // ë¡œë”© ìƒíƒœ í‘œì‹œ
                if (loadingElement) loadingElement.style.display = 'block';
                if (contentElement) contentElement.style.opacity = '0.5';
                if (searchButton) searchButton.disabled = true;
                if (noDataElement) noDataElement.style.display = 'none';

                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                // ë‚ ì§œ í˜•ì‹ì„ ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const startDateTime = new Date(startDate + 'T00:00:00').toISOString();
                const endDateTime = new Date(endDate + 'T23:59:59').toISOString();
                
                const response = await fetch(`/api/statistics?startDate=${startDateTime}&endDate=${endDateTime}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    throw new Error('í†µê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const data = await response.json();

                // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
                if (data.totalOrders === 0) {
                    if (contentElement) contentElement.style.display = 'none';
                    if (noDataElement) noDataElement.style.display = 'block';
                } else {
                    if (contentElement) contentElement.style.display = 'block';
                    if (noDataElement) noDataElement.style.display = 'none';
                    updateStatistics(data);
                    updateCharts(data);
                }
            } catch (error) {
                alert(error.message);
            } finally {
                // ë¡œë”© ìƒíƒœ í•´ì œ
                if (loadingElement) loadingElement.style.display = 'none';
                if (contentElement) contentElement.style.opacity = '1';
                if (searchButton) searchButton.disabled = false;
            }
        }

        function exportToCSV() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // CSV í—¤ë”
            let csvContent = 'ê¸°ê°„,' + startDate + ' ~ ' + endDate + '\n\n';
            
            // ê¸°ë³¸ í†µê³„
            csvContent += 'ê¸°ë³¸ í†µê³„\n';
            csvContent += 'ì´ ì£¼ë¬¸ ìˆ˜,' + document.getElementById('totalOrders').textContent + 'ê±´\n';
            csvContent += 'ì™„ë£Œìœ¨,' + document.getElementById('completionRate').textContent + '\n';
            csvContent += 'í‰ê·  ì²˜ë¦¬ ì‹œê°„,' + document.getElementById('avgProcessingTime').textContent + 'ë¶„\n\n';
            
            // ì£¼ë¬¸ ìƒíƒœ ë¶„í¬
            csvContent += 'ì£¼ë¬¸ ìƒíƒœ ë¶„í¬\n';
            const statusLabels = statusChart.data.labels;
            const statusData = statusChart.data.datasets[0].data;
            statusLabels.forEach((label, index) => {
                csvContent += label + ',' + statusData[index] + 'ê±´\n';
            });
            csvContent += '\n';
            
            // ì¸ê¸° ìƒí’ˆ
            csvContent += 'ì¸ê¸° ìƒí’ˆ TOP 5\n';
            const itemLabels = popularItemsChart.data.labels;
            const itemData = popularItemsChart.data.datasets[0].data;
            itemLabels.forEach((label, index) => {
                csvContent += label + ',' + itemData[index] + 'ê±´\n';
            });
            
            // CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ì£¼ë¬¸í†µê³„_${startDate}_${endDate}.csv`;
            link.click();
        }

        function exportCharts() {
            // ìƒíƒœ ë¶„í¬ ì°¨íŠ¸ ì €ì¥
            const statusLink = document.createElement('a');
            statusLink.download = 'ì£¼ë¬¸ìƒíƒœë¶„í¬.png';
            statusLink.href = document.getElementById('statusChart').toDataURL('image/png');
            statusLink.click();

            // ì ì‹œ ëŒ€ê¸° í›„ ì¸ê¸° ìƒí’ˆ ì°¨íŠ¸ ì €ì¥
            setTimeout(() => {
                const itemsLink = document.createElement('a');
                itemsLink.download = 'ì¸ê¸°ìƒí’ˆ.png';
                itemsLink.href = document.getElementById('popularItemsChart').toDataURL('image/png');
                itemsLink.click();
            }, 500);
        }

        // í•œê¸€ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•œ í°íŠ¸ ë¡œë“œ ëŒ€ê¸°
        document.fonts.ready.then(() => {
            // ì°¨íŠ¸ ì˜µì…˜ì— í°íŠ¸ ì„¤ì • ì¶”ê°€
            const defaultOptions = {
                plugins: {
                    legend: {
                        labels: {
                            font: {
                                family: "'Roboto', 'Noto Sans KR', sans-serif"
                            }
                        }
                    }
                }
            };

            // ê¸°ì¡´ ì°¨íŠ¸ ì˜µì…˜ê³¼ ë³‘í•©
            if (statusChart) {
                statusChart.options = { ...statusChart.options, ...defaultOptions };
                statusChart.update('none');
            }
            if (popularItemsChart) {
                popularItemsChart.options = { ...popularItemsChart.options, ...defaultOptions };
                popularItemsChart.update('none');
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            initializeCharts();
            
            // ê¸°ë³¸ ë‚ ì§œ ë²”ìœ„ ì„¤ì •
            const defaultRange = getDefaultDateRange();
            document.getElementById('startDate').value = defaultRange.start;
            document.getElementById('endDate').value = defaultRange.end;
            
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadStatistics();

            // ë‚ ì§œ ì…ë ¥ í•„ë“œì— ìµœëŒ€ê°’ ì„¤ì • (ì˜¤ëŠ˜ê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥)
            const today = formatDate(new Date());
            document.getElementById('startDate').max = today;
            document.getElementById('endDate').max = today;
        });

        function handleProtectedLink(url) {
            if (typeof auth !== 'undefined' && auth.isLoggedIn && auth.isLoggedIn()) {
                window.location.href = url;
            } else {
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html> 